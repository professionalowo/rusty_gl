name: Check and Test

on: push

env:
    CARGO_TERM_COLOR: always
    CMAKE_POLICY_VERSION_MINIMUM: 3.5
    DEBIAN_FRONTEND: noninteractive

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      install: sudo apt-get update -qq && sudo apt-get install -qy libglfw3-dev libgl1-mesa-dev
                    - os: macos-latest
                      install: brew install glfw
        steps:
            - uses: actions/checkout@v4
              with:
                submodules: recursive
                fetch-depth: 1

            - name: Install Dependencies
              run: ${{ matrix.install }}

            - uses: actions/cache@v4
              with:
                path: |
                  ~/.cargo/bin/
                  ~/.cargo/registry/index/
                  ~/.cargo/registry/cache/
                  ~/.cargo/git/db/
                  target/
                key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }} 

            - name: Check
              run: cargo check --verbose

            - name: Run tests
              run: cargo test --verbose
